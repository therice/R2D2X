local ItemUtil

describe("LibItemUtil", function()
    setup(function()
        loadfile("Test/TestSetup.lua")(false, '.LibItemUtil')
        loadfile("Test/WowXmlParser.lua")()
        ParseXmlAndLoad('Libs/CallbackHandler-1.0/CallbackHandler-1.0.xml')
        ParseXmlAndLoad('Libs/AceEvent-3.0/AceEvent-3.0.xml')
        ParseXmlAndLoad('Libs/LibDeformat-3.0/LibDeformat-3.0.xml')
        ParseXmlAndLoad('Libs/LibDeflate/LibDeflate.xml')
        ParseXmlAndLoad('Libs/LibClass-1.0/LibClass-1.0.xml')
        ParseXmlAndLoad('Libs/LibLogging-1.0/LibLogging-1.0.xml')
        ParseXmlAndLoad('Libs/LibUtil-1.1/LibUtil-1.1.xml')
        ParseXmlAndLoad('Libs/LibItemUtil-1.1/LibItemUtil-1.1.xml')
        loadfile("Libs/LibItemUtil-1.1/Test/LibItemUtilTestData.lua")()
        ConfigureLogging()
        ItemUtil = LibStub('LibItemUtil-1.1')

    end)
    teardown(function()
        After()
    end)
    describe("item ids", function()
        it("resolved from item links", function()
            id = ItemUtil:ItemLinkToId("|cff9d9d9d|Hitem:7073::::::::::::|h[Broken Fang]|h|r")
            assert.equals(id, 7073)
        end)
        it("resolve whether a class can use", function()
            -- 28 ('Hitem:19724' - Primal Hakkari Aegis : Hunter, Rogue, Priest)
            assert.is.True(ItemUtil:ClassCanUse("PRIEST", 28))
            assert.is.Not.True(ItemUtil:ClassCanUse("DRUID", 28))
            assert.is.Not.True(ItemUtil:ClassCanUse("WARRIOR", 28))
            assert.is.True(ItemUtil:ClassCanUse("ROGUE", 28))
            assert.is.True(ItemUtil:ClassCanUse("HUNTER", 28))
            
            -- 4294967295 ('Hitem:12757' Breastplate of Bloodthirst)
            assert.is.Not.True(ItemUtil:ClassCanUse('PRIEST', 4294967295, INVTYPE_CHEST, LE_ITEM_CLASS_ARMOR, LE_ITEM_ARMOR_LEATHER))
            assert.is.True(ItemUtil:ClassCanUse('ROGUE', 4294967295, INVTYPE_CHEST, LE_ITEM_CLASS_ARMOR, LE_ITEM_ARMOR_LEATHER))
            assert.is.True(ItemUtil:ClassCanUse('WARRIOR', 4294967295, INVTYPE_CHEST, LE_ITEM_CLASS_ARMOR, LE_ITEM_ARMOR_LEATHER))
        end)
        it("resolve to item info", function()
            local fired = false
            ItemUtil:QueryItemInfo(18832, function() fired = true end)
            WoWAPI_FireEvent('GET_ITEM_INFO_RECEIVED', 18832, true)
            assert.is_true(fired)
        end)
    end)
    describe("custom items", function()
        it("is empty upon loading", function()
            assert.equal(0, GetSize(ItemUtil:GetCustomItems()))
        end)
        it("can be supplied", function()
            ItemUtil:SetCustomItems(TestCustomItems)
            assert.equal(4, GetSize(ItemUtil:GetCustomItems()))
        end)
        it("can be added", function()
            ItemUtil:SetCustomItems({})
            assert.equal(0, GetSize(ItemUtil:GetCustomItems()))
            ItemUtil:AddCustomItem(18422, 4, 74, "INVTYPE_NECK", "Horde")
            assert.equal(1, GetSize(ItemUtil:GetCustomItems()))
            ItemUtil:AddCustomItem(20928, 4, 78, "INVTYPE_SHOULDER")
            assert.equal(2, GetSize(ItemUtil:GetCustomItems()))
        end)
        it("can be removed", function()
            ItemUtil:SetCustomItems({})
            ItemUtil:AddCustomItem(18422, 4, 74, "INVTYPE_NECK", "Horde")
            ItemUtil:AddCustomItem(20928, 4, 78, "INVTYPE_SHOULDER")
            assert.equal(2, GetSize(ItemUtil:GetCustomItems()),
                    "Expected custom item count incorrect"
            )
            ItemUtil:RemoveCustomItem(18422)
            assert.equal(1, GetSize(ItemUtil:GetCustomItems()),
                    "Expected custom item count incorrect"
            )
        end)
    end)
end)
